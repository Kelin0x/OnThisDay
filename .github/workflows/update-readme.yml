name: æ¯æ—¥å†å²æ›´æ–°

on:
  schedule:
    - cron: "0 16 * * *"  # UTCæ—¶é—´16:00ï¼ˆåŒ—äº¬æ—¶é—´00:00ï¼‰
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å¿…é¡»å¼€å¯å†™å…¥æƒé™

    steps:
    - name: æ£€å‡ºä»“åº“ï¼ˆå®Œæ•´å†å²ï¼‰
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # æ‹‰å–å®Œæ•´æäº¤å†å²
        token: ${{ secrets.ACCESS_TOKEN }}  # æ¢æˆæ‚¨çš„ä¸ªäººè®¿é—®ä»¤ç‰Œ(PAT)

    - name: é…ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests pytz

    - name: æ‰§è¡Œæ›´æ–°è„šæœ¬
      run: python update_readme.py
      env:
        TZ: Asia/Shanghai  # å¼ºåˆ¶è®¾ç½®æ—¶åŒº

    - name: æ£€æµ‹æ–‡ä»¶å˜åŒ–
      id: check_change
      run: |
        echo "å˜æ›´çŠ¶æ€ï¼š"
        git status -s
        if git diff --exit-code --quiet README.md; then
          echo "has_change=false" >> $GITHUB_OUTPUT
        else
          echo "has_change=true" >> $GITHUB_OUTPUT
        fi

    - name: æäº¤å˜æ›´
      if: steps.check_change.outputs.has_change == 'true'
      run: |
        # é…ç½®Gitèº«ä»½
        git config --global user.name "${{ github.actor }}"
        git config --global user.email "${{ github.actor }}@users.noreply.github.com"

        # æäº¤å˜æ›´
        git add README.md
        git commit -m "ğŸ“š è‡ªåŠ¨æ›´æ–°å†å²æ•°æ® ($(date +'%Y-%m-%d %H:%M:%S'))"
        
        # å¼ºåˆ¶æ¨é€é¿å…å†²çª
        git pull --rebase origin main
        git push origin main
